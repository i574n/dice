open rust_operators

inl render () =
    print_static "<transactions.render>"
    leptos.log $'"transactions.render ()"'

    inl global_state : state.global_state = leptos.use_context () |> optionm'.unwrap

    inl url = leptos.create_memo fun () =>
        inl account = "i574n.near"

        $'"https://api2.nearblocks.io/v1/account/" + !account + "/txns?&order=desc&page=1&per_page=25"'
        |> Some
        |> optionm'.box
        |> fun x =>
            inl x_log = x |> sm'.format_debug
            leptos.log $'"transactions.render () / url create_memo / result: " + string !x_log + ""'
            x

    inl root : rust.func0 (resultm.result' (optionm'.option' model.near.nearblocks.root) rust.std_string) =
        state.use_request url model.near.nearblocks.root_unbox

    inl txns : rust.func0 (result (option (array_base (unativeint * heap model.near.nearblocks.txn))) rust.std_string) =
        rust.move fun () =>
            root
            |> rust.func0_get
            |> resultm.unbox
            |> resultm.map fun result =>
                result
                |> optionm'.unbox
                |> optionm.map fun result =>
                    (a result.txns : _ i32 _)
                    |> am'.enumerate
                    |> am'.map_vec fun i, x => i, heap x
                    |> fun (a x : _ i32 _) => x
            |> fun x =>
                inl x_log = x |> sm'.format_debug
                leptos.log $'"transactions.render () / txns move / result length: " + (!x_log |> string |> String.length |> string) + ""'
                x
    
    inl (settings_visible, set_settings_visible) = leptos.create_signal false
    
    inl settings_button =
        leptos.icon_button
            (leptos.settings_svg ())
            None
            [
                
            ]
        |> leptos.element_to_view

    ;[
        leptos.accordion "Transactions" true (Some settings_button) fun () =>
            match txns |> rust.func0_get with
            | Ok (Some transactions) =>
                // match true with
                // | false =>
                :>(;[
                    leptos.div [
                        $'"class=\\\"grid flex-1 py-[10px] px-[12px] [gap:15px] sm:[grid-template-columns:repeat(auto-fill,minmax(500px,1fr))]\\\""'
                    ] fun () =>
                        leptos.for
                            transactions
                            fun _, transaction => transaction.transaction_hash
                            fun index, transaction' =>
                                !transaction'
                                |> transaction.render (index |> i64)
                                |> leptos.element_to_fragment
                        |> leptos.view_to_fragment
                    |> leptos.element_to_view
                // | true =>
                    leptos.table [
                        $'"class=\\\"min-w-full divide-y-2 divide-gray-200 text-sm dark:divide-gray-700\\\""'
                    ] fun () =>
                        :>(;[
                            leptos.thead [
                                $'"class=\\\"ltr:text-left rtl:text-right\\\""'
                            ] fun () =>
                                :>(;[
                                    leptos.tr [

                                    ] fun () =>
                                        :>(;[
                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Block Timestamp" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Predecessor" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Receiver" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Deposit" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Outcome Status" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Fee" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Block Height" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Hash" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Block Hash" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                "Receipt ID" |> leptos.text_fragment
                                            |> leptos.element_to_view

                                            leptos.th [
                                                $'"class=\\\"whitespace-nowrap px-4 py-2 font-medium text-gray-900 dark:text-white\\\""'
                                            ] fun () =>
                                                (a transactions : _ i32 _)
                                                |> am.exists fun _index, transaction' =>
                                                    (a transaction'.logs : _ i32 _)
                                                    |> am.exists fun log =>
                                                        (log |> sm'.from_std_string |> sm.length) > 0i32
                                                |> function
                                                    | false => ""
                                                    | _ => "Logs"
                                                    |> leptos.text_fragment
                                            |> leptos.element_to_view
                                        ])
                                ])
                            |> leptos.element_to_view

                            leptos.tbody [
                                $'"class=\\\"divide-y divide-gray-200 dark:divide-gray-700\\\""'
                            ] fun () =>
                                leptos.for
                                    transactions
                                    fun _, transaction => transaction.transaction_hash
                                    fun index, transaction' =>
                                        leptos.tr [
                                            $'"class=\\\"odd:bg-gray-50 dark:odd:bg-gray-800/50\\\""'
                                        ] fun () =>
                                            :>(;[
                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                    transaction'.block_timestamp
                                                    |> transaction.format_block_timestamp
                                                    |> to_string
                                                    |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                    transaction'.predecessor_account_id
                                                    |> to_string
                                                    |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                    transaction'.receiver_account_id
                                                    |> to_string
                                                    |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                // leptos.td [
                                                //     $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                // ] fun () =>
                                                //     a transaction.actions
                                                //     |> am'.map_vec fun { action method } =>
                                                //         leptos.grid_pair
                                                //             { padding = Some "items-center"; cols = Some ""; class = "" }
                                                //             fun () =>
                                                //                 match action |> sm'.from_std_string with
                                                //                 | "FUNCTION_CALL" => "Function Call:"
                                                //                 | "DEPLOY_CONTRACT" => "Contract Deploy:"
                                                //                 | "TRANSFER" => "Transfer:"
                                                //                 | action => action
                                                //                 |> leptos.text_fragment
                                                //             fun () =>
                                                //                 leptos.div [
                                                //                     $'"class=\\\"flex flex-1 flex-col\\\""'
                                                //                 ] fun () => :>(;[
                                                //                     leptos.grid_pair
                                                //                         { padding = Some ""; cols = None; class = "" }
                                                //                         fun () => "Method" |> leptos.text_fragment
                                                //                         fun () =>
                                                //                             match method with
                                                //                             | Some method =>
                                                //                                 method
                                                //                                 |> to_string
                                                //                                 |> leptos.text_fragment
                                                //                             | None =>
                                                //                                 "None" |> leptos.text_fragment
                                                //                     |> leptos.element_to_view
                                                //                 ])
                                                //                 |> leptos.element_to_fragment
                                                //     |> fun (a x : _ i32 _) => :>x
                                                // |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                    transaction'.actions_agg.deposit
                                                    |> sm'.obj_to_string
                                                    |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                    transaction'.outcomes.status
                                                    |> sm'.obj_to_string
                                                    |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                    transaction'.outcomes_agg.transaction_fee
                                                    |> sm'.obj_to_string
                                                    |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                    transaction'.block.block_height
                                                    |> sm'.obj_to_string
                                                    |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                    transaction'.transaction_hash
                                                    |> to_string
                                                    |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                        transaction'.included_in_block_hash
                                                        |> to_string
                                                        |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400\\\""'
                                                ] fun () =>
                                                        transaction'.receipt_id
                                                        |> to_string
                                                        |> leptos.text_fragment
                                                |> leptos.element_to_view

                                                leptos.td [
                                                    $'"class=\\\"whitespace-nowrap px-4 py-2 text-gray-700 dark:text-gray-400 [overflow:auto]\\\""'
                                                ] fun () =>
                                                    match transaction'.logs with
                                                    | ;[] => "" |> leptos.text_fragment
                                                    | _ =>
                                                        (a transaction'.logs : _ i32 _)
                                                        |> am'.map_vec sm'.from_std_string
                                                        |> sm'.concat "\n"
                                                        |> sm'.replace "\\n" "\n"
                                                        |> leptos.text_block_pre "[max-height:20vh]"
                                                        |> leptos.element_to_fragment
                                                |> leptos.element_to_view
                                            ])
                                        |> leptos.element_to_fragment
                                |> leptos.view_to_fragment
                            |> leptos.element_to_view
                        ])
                    |> leptos.element_to_view
                ])
            | Error error =>
                leptos.div [
                    $'"class=\\\"flex flex-1 [gap:4px] [padding:5px]\\\""'
                ] fun () => :>(;[
                    leptos.span [
                        $'"class=\\\"[height:20px]\\\""'
                    ] fun () => :>(;[
                        leptos.x_red_svg () |> leptos.element_to_view
                    ])
                    |> leptos.element_to_view

                    leptos.pre [
                        $'"class=\\\"[overflow-y:auto]\\\""'
                    ] fun () =>
                        error |> sm'.from_std_string |> leptos.text_fragment
                    |> leptos.element_to_view
                ])
                |> leptos.element_to_fragment
            | _ =>
                leptos.div [
                    $'"class=\\\"grid place-content-center py-[10vh]\\\""'
                ] fun () =>
                    leptos.div [
                        $'"class=\\\"flex flex-1 [gap:4px] items-center\\\""'
                    ] fun () => :>(;[
                        leptos.loading_svg () |> leptos.element_to_view
                        $'"Loading..."' |> leptos.text_view
                    ])
                    |> leptos.element_to_fragment
                |> leptos.element_to_fragment
        |> leptos.element_to_view

        if leptos.signal_get_untracked global_state.core_state .debug |> leptos.signal_get then
            leptos.accordion "Debug" true None fun () =>
                :>(;[
                    leptos.grid_pair
                        { padding = None; cols = None; class = "" }
                        fun () => "Transactions" |> leptos.text_fragment
                        fun () =>
                            txns
                            |> rust.func0_get
                            |> sm'.format_pretty'
                            |> sm'.from_std_string
                            |> leptos.text_block_pre "[max-height:70vh]"
                            |> leptos.element_to_fragment
                ])
            |> leptos.element_to_view
        else ;[] |> leptos.views_to_view
    ]
